<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin-top: 0;
            color: #333;
        }
        .controls {
            margin-bottom: 24px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 12px;
            padding: 8px;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .balances {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .balance-card {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .balance-card h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
        }
        .balance-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .balance-card .pnl {
            font-size: 14px;
            margin-top: 4px;
        }
        .balance-card .pnl.positive {
            color: #28a745;
        }
        .balance-card .pnl.negative {
            color: #dc3545;
        }
        .positions {
            margin-top: 24px;
        }
        .positions h2 {
            margin-bottom: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .pnl-positive {
            color: #28a745;
        }
        .pnl-negative {
            color: #dc3545;
        }
        .last-updated {
            margin-top: 16px;
            color: #666;
            font-size: 14px;
        }
        .chart-section {
            margin-top: 24px;
            margin-bottom: 24px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .chart-section h2 {
            margin-top: 0;
            margin-bottom: 16px;
            color: #333;
            font-size: 18px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            background: white;
            border-radius: 4px;
            padding: 16px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            background: white;
            border-radius: 4px;
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Portfolio Dashboard</h1>
        
        <div class="controls">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 4px;">Auto-refreshing every 5 minutes</div>
                    <div id="lastUpdated" style="font-size: 16px; color: #333; font-weight: 500;">Loading...</div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <a href="https://polymarket.com/profile/0x234b0E87Da5579300a8cB3c1D29a9DD3d1e16144" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(0, 123, 255, 0.1); color: #007bff; text-decoration: none; border-radius: 12px; font-size: 13px; font-weight: 500; transition: all 0.2s ease; border: 0.5px solid rgba(0, 123, 255, 0.2);">
                        0x234b0E87Da5579300a8cB3c1D29a9DD3d1e16144
                    </a>
                    <a href="/auth" style="color: #007bff; text-decoration: none; font-size: 14px;">⚙️ Telegram Settings</a>
                </div>
            </div>
            <div id="status"></div>
        </div>

        <div id="portfolio">
            <p>Loading portfolio data...</p>
        </div>
    </div>

    <script>
        function updateLastUpdated(timestamp) {
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (timestamp) {
                const date = new Date(timestamp);
                lastUpdatedEl.textContent = `Last updated: ${date.toLocaleString()}`;
            } else {
                lastUpdatedEl.textContent = 'Last updated: Never';
            }
        }

        async function loadPortfolio() {
            try {
                const response = await fetch('/api/portfolio/latest');
                if (!response.ok) {
                    throw new Error('No portfolio data found');
                }
                
                const data = await response.json();
                displayPortfolio(data);
            } catch (error) {
                document.getElementById('portfolio').innerHTML = 
                    `<p style="color: #dc3545;">Error loading portfolio: ${error.message}</p>`;
            }
        }

        function displayPortfolio(data) {
            const portfolio = document.getElementById('portfolio');
            const snapshot = data;
            const positions = data.positions || [];
            
            const lastUpdated = new Date(snapshot.timestamp).toLocaleString();
            
            let html = `
                <div class="balances">
                    <div class="balance-card">
                        <h3>Total Balance</h3>
                        <div class="value">$${formatNumber(snapshot.total_balance)}</div>
                    </div>
                    <div class="balance-card">
                        <h3>Available</h3>
                        <div class="value">$${formatNumber(snapshot.available_balance)}</div>
                    </div>
                    <div class="balance-card">
                        <h3>Invested</h3>
                        <div class="value">$${formatNumber(snapshot.invested)}</div>
                    </div>
                    <div class="balance-card">
                        <h3>Total PnL</h3>
                        <div class="value">$${formatNumber(snapshot.total_pnl_usd)}</div>
                        <div class="pnl ${snapshot.total_pnl_pct >= 0 ? 'positive' : 'negative'}">
                            ${snapshot.total_pnl_pct >= 0 ? '+' : ''}${formatNumber(snapshot.total_pnl_pct)}%
                        </div>
                    </div>
                </div>
                <div class="chart-section" id="balanceChartContainer">
                    <h2>Balance Over Time</h2>
                    <div class="chart-container">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
            `;
            
            portfolio.innerHTML = html;
            
            // Load and display chart - wait a bit for DOM to update
            setTimeout(() => {
                loadBalanceChart();
            }, 100);
            
            // Then add positions section
            if (positions.length > 0 || snapshot.total_positions) {
                const positionCount = snapshot.total_positions || positions.length;
                let positionsHtml = `
                    <div class="positions">
                        <h2>Positions (${positionCount})</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Market</th>
                                    <th>Side</th>
                                    <th>Entry Price</th>
                                    <th>Value</th>
                                    <th>PnL</th>
                                    <th>PnL %</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                positions.forEach(pos => {
                    positionsHtml += `
                        <tr>
                            <td>${escapeHtml(pos.market_question)}</td>
                            <td>${pos.side}</td>
                            <td>$${formatNumber(pos.entry_price)}</td>
                            <td>$${formatNumber(pos.value)}</td>
                            <td class="${pos.pnl_usd >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                $${formatNumber(pos.pnl_usd)}
                            </td>
                            <td class="${pos.pnl_pct >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${pos.pnl_pct >= 0 ? '+' : ''}${formatNumber(pos.pnl_pct)}%
                            </td>
                        </tr>
                    `;
                });
                
                positionsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                portfolio.innerHTML += positionsHtml;
            } else {
                portfolio.innerHTML += '<p>No positions found.</p>';
            }
            
            // Update the last updated timestamp in the header
            updateLastUpdated(snapshot.timestamp);
        }

        let balanceChart = null;

        async function loadBalanceChart() {
            try {
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded');
                    return;
                }
                
                const response = await fetch('/api/portfolio/balance-history?limit=100');
                if (!response.ok) {
                    console.error('Failed to load balance history:', response.status);
                    return;
                }
                const result = await response.json();
                const data = result.history || result; // Support both old and new format
                const investedByTrader = result.investedByTrader || [];
                
                if (!data || data.length === 0) {
                    return; // No data to chart yet
                }

                // Chart container should already exist in the HTML (inserted after balances)
                const chartCanvas = document.getElementById('balanceChart');
                if (!chartCanvas) {
                    console.error('Chart canvas not found');
                    return;
                }

                const ctx = chartCanvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get 2d context from canvas');
                    return;
                }
                
                // Destroy existing chart if it exists
                if (balanceChart) {
                    balanceChart.destroy();
                }

                // Build datasets for invested by trader
                const datasets = [
                    {
                        label: 'Total Balance',
                        data: data.map(d => d.total_balance),
                        borderColor: '#007aff',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderWidth: 2.5,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: '#007aff',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2
                    }
                ];

                // Group invested by trader data by timestamp
                const traderDataMap = new Map();
                investedByTrader.forEach(item => {
                    const key = item.timestamp;
                    if (!traderDataMap.has(key)) {
                        traderDataMap.set(key, {});
                    }
                    traderDataMap.get(key)[item.trader] = item.invested;
                });

                // Get unique traders
                const traders = [...new Set(investedByTrader.map(item => item.trader))];

                // Generate colors for each trader
                const traderColors = [
                    { border: '#30d158', fill: 'rgba(48, 209, 88, 0.1)' }, // Green
                    { border: '#ff9500', fill: 'rgba(255, 149, 0, 0.1)' }, // Orange
                    { border: '#ff3b30', fill: 'rgba(255, 59, 48, 0.1)' }, // Red
                    { border: '#af52de', fill: 'rgba(175, 82, 222, 0.1)' }, // Purple
                    { border: '#5ac8fa', fill: 'rgba(90, 200, 250, 0.1)' }, // Light Blue
                    { border: '#ffcc00', fill: 'rgba(255, 204, 0, 0.1)' }, // Yellow
                ];

                // Create a dataset for each trader
                traders.forEach((trader, index) => {
                    const color = traderColors[index % traderColors.length];
                    const traderData = data.map(d => {
                        const timestampData = traderDataMap.get(d.timestamp);
                        return timestampData && timestampData[trader] ? timestampData[trader] : 0;
                    });

                    datasets.push({
                        label: `Invested: ${trader}`,
                        data: traderData,
                        borderColor: color.border,
                        backgroundColor: color.fill,
                        borderWidth: 2.5,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: color.border,
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2
                    });
                });

                // If no traders, show total invested
                if (traders.length === 0) {
                    datasets.push({
                        label: 'Invested',
                        data: data.map(d => d.invested),
                        borderColor: '#30d158',
                        backgroundColor: 'rgba(48, 209, 88, 0.1)',
                        borderWidth: 2.5,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: '#30d158',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2
                    });
                }

                balanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => new Date(d.timestamp).toLocaleString()),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 13,
                                        weight: '500',
                                        family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif'
                                    },
                                    color: '#1d1d1f'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                backdropFilter: 'blur(10px)',
                                padding: 12,
                                titleFont: {
                                    size: 13,
                                    weight: '600',
                                    family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif'
                                },
                                bodyFont: {
                                    size: 13,
                                    weight: '400',
                                    family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif'
                                },
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                    }
                                },
                                cornerRadius: 10,
                                displayColors: true
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 11,
                                        family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif'
                                    },
                                    color: '#86868b'
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 11,
                                        family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif'
                                    },
                                    color: '#86868b',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '0.00';
            return parseFloat(num).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load portfolio on page load
        window.addEventListener('load', () => {
            loadPortfolio();
            // Auto-refresh the display every 30 seconds to catch auto-updates
            setInterval(loadPortfolio, 30000);
        });
    </script>
</body>
</html>

